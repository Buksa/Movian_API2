Этот код реализует функциональность для мониторинга и управления контекстами ECMAScript (JavaScript) в приложении, которое использует Duktape в качестве движка JavaScript. Код предоставляет HTTP-интерфейс для получения статистики о контекстах и принудительного запуска сборки мусора (garbage collection, GC). Давайте разберем его подробнее.

---

## Основные функции

### `dump_resource_list(out, list)`
Выводит список ресурсов, привязанных к контексту ECMAScript.

**Параметры:**
- `out` (htsbuf_queue_t) — Буфер для вывода данных.
- `list` (struct es_resource_list) — Список ресурсов.

**Описание:**
Функция проходит по списку ресурсов и добавляет информацию о каждом ресурсе в буфер вывода. Если у ресурса есть функция `erc_info`, она вызывается для получения дополнительной информации.

---

### `dump_context(out, ec)`
Выводит информацию о контексте ECMAScript.

**Параметры:**
- `out` (htsbuf_queue_t) — Буфер для вывода данных.
- `ec` (es_context_t) — Контекст ECMAScript.

**Описание:**
Функция выводит:
- Идентификатор контекста.
- Путь, откуда был загружен контекст.
- Использование памяти (текущее и пиковое).
- Количество закрепленных (rooted) объектов.
- Количество активных нативных объектов (по классам).
- Список постоянных ресурсов, привязанных к контексту.

---

### `dumpstats(hc, remain, opaque, method)`
Обрабатывает HTTP-запрос для получения статистики по всем контекстам ECMAScript.

**Параметры:**
- `hc` (http_connection_t) — HTTP-соединение.
- `remain` (const char) — Оставшаяся часть URL после совпадения.
- `opaque` (void) — Дополнительные данные (не используется).
- `method` (http_cmd_t) — HTTP-метод (GET, POST и т.д.).

**Возвращает:**
HTTP-ответ с текстовой статистикой.

**Описание:**
Функция собирает статистику по всем контекстам ECMAScript и отправляет её в виде текстового ответа.

---

### `dogc(hc, remain, opaque, method)`
Обрабатывает HTTP-запрос для принудительного запуска сборки мусора во всех контекстах ECMAScript.

**Параметры:**
- `hc` (http_connection_t) — HTTP-соединение.
- `remain` (const char) — Оставшаяся часть URL после совпадения.
- `opaque` (void) — Дополнительные данные (не используется).
- `method` (http_cmd_t) — HTTP-метод (GET, POST и т.д.).

**Возвращает:**
HTTP-ответ с сообщением "OK".

**Описание:**
Функция запускает сборку мусора (duk_gc) во всех контекстах ECMAScript.

---

### `ecmascript_stats_init()`
Инициализирует HTTP-маршруты для работы со статистикой и сборкой мусора.

**Описание:**
Функция добавляет два маршрута:
1. `/api/ecmascript/stats` — для получения статистики.
2. `/api/ecmascript/gc` — для запуска сборки мусора.

---

## Примеры использования

### Получение статистики
Отправьте HTTP-запрос GET на `/api/ecmascript/stats`. В ответ вы получите текстовую статистику по всем контекстам ECMAScript, например:

```
--- context1 ------------------------
  Loaded from /path/to/script.js
  Memory usage, current: 1024 bytes, peak: 2048
  Rooted Ecmascript objects: 5
  Native objects referenced:
    MyClass: 3 active
  Attached permanent resources:
    resource1: info
    resource2
```

### Запуск сборки мусора
Отправьте HTTP-запрос GET на `/api/ecmascript/gc`. В ответ вы получите сообщение "OK", и во всех контекстах ECMAScript будет запущена сборка мусора.

---

## Инициализация модуля
Модуль инициализируется с помощью макроса `INITME`, который регистрирует функцию `ecmascript_stats_init` в группе инициализации `INIT_GROUP_API`. Это гарантирует, что маршруты будут добавлены при запуске приложения.

```c
INITME(INIT_GROUP_API, ecmascript_stats_init, NULL, 0);
```

---

## Зависимости
Код зависит от следующих компонентов:
- **Duktape**: Для работы с JavaScript.
- **HTTP-сервер**: Для обработки запросов.
- **Менеджер ресурсов**: Для управления ресурсами, привязанными к контекстам ECMAScript.

---

## Примечания
- Код активен только при включенном флаге `ENABLE_HTTPSERVER`.
- Функции `dumpstats` и `dogc` защищены от многопоточного доступа с помощью мьютексов.
- Для работы с ресурсами используется механизм подсчета ссылок и привязки к контекстам.

---

Этот код полезен для отладки и мониторинга производительности приложений, использующих ECMAScript, особенно в средах с ограниченными ресурсами, где важно контролировать использование памяти.
